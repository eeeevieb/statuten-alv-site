<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statuten-ALV voortgang</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            align-items: center;
            padding-top: 50px;
            background-color: #9F81BA;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- <p>
            We hebben op dit moment 79 leden in de vereniging. Er moet tweederde daarvan gerepresenteerd zijn op de ALV. Dat zijn 56 mensen.
        </p> -->
        <h1>Help ons de statuten te wijzigen!</h1>
        <p class="amount-members" id = "amountMembers">Loading count...</p>
        <!-- <p class="members-needed" id="membersNeeded">Loading count...</p> -->
        <!-- <p class="people-count" id="peopleCount">Loading count...</p> -->
        <p> </p>
    <!-- </div>
    <div class="container">
        <h1>Current Progress</h1> -->

        <!-- Progress Bar Area -->
        <div class="progress-container">
            <div class="progress-bar-background">
                <div class="progress-bar-value" id="progressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <!-- Optional: Text inside the bar -->
                    <!-- <span id="progressTextInner">0%</span> -->
                </div>
            </div>
        </div>

        <!-- Percentage Text Area -->
        <div class="progress-percentage-text" id="percentageText">Loading...</div>
        <div id="errorDisplay" class="error"></div>
    </div>
    <div class="container">
        <h2>Hoe kan ik helpen?</h2>
        <p>Je kan zelf langskomen op 19 mei om 19:30 in de Krater. Schrijf je dan in op <a href="https://kiwi.particolarte.nl/activity/0195b56d-a763-7397-88a0-a2010992658e" target="_blank" >Kiwi</a>. Als dat niet lukt, kan je iemand machtigen door te mailen naar <a href="mailto:secretaris@particolarte.nl?subject=Machtiging%20statuten-ALV&body=Hoi%20secretaris!%0A%0AIk%20wil%20graag%20%5BINSERT%20NAAM%5D%20machtigen%20voor%20de%20statuten-ALV." target="_blank">secretaris@particolarte.nl</a>. Op <a href="https://kiwi.particolarte.nl/activity/0195b56d-a763-7397-88a0-a2010992658e" target="_blank" >Kiwi</a> kan je zien wie er komen. Je hoeft niet te wachten met machtigen, het kan nu!</p>
    </div>
    <break></break>
    <div class="container">
        <p>Note: Ik zit zelf aan de back-end van deze site. De meter zal pas updaten wanneer ik in mijn mail of op Kiwi heb gekeken hihi</p>
        <p>xo jullie allerliefste secretaris</p>
    </div>
    <script>
        // --- Configuration ---
        // !! IMPORTANT !! Replace with YOUR *CSV* publish URL
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRUcIyqcUhGu8oHtG4Pw8fHvVdH6YibbYN77EcGEZqbZ_vM8fdcWvjQQYb8rzZCvZMHp67QBlbj0mts/pub?output=csv';

        // !! IMPORTANT !! Adjust indices for your specific cells
        // Percentage Cell (e.g., H6)
        const PERCENTAGE_ROW_INDEX = 7; // Row 6 is index 5
        const PERCENTAGE_COL_INDEX = 0; // Column H is index 7

        // People Count Cell (e.g., I6)
        const COUNT_ROW_INDEX = 1;    // Row 6 is index 5 (Same row as percentage)
        const COUNT_COL_INDEX = 0;    // Column I is index 8

        const MEM_ROW_INDEX = 15;
        const MEM_COL_INDEX = 0;

        const NEED_ROW_INDEX = 4;
        const NEED_COL_INDEX = 0;

        const POLLING_INTERVAL_MS = 15000; // Check every 15 seconds

        // --- End Configuration ---

        const progressBarElement = document.getElementById('progressBar');
        const percentageTextElement = document.getElementById('percentageText');
        const peopleCountElement = document.getElementById('peopleCount'); // Get reference to new paragraph
        const amountMembersElement = document.getElementById('amountMembers');
        const membersNeededElement = document.getElementById('membersNeeded');
        const errorElement = document.getElementById('errorDisplay');

        // Renamed function to reflect it fetches multiple data points
        async function fetchAndUpdateData() {
            console.log('Fetching data...');
            errorElement.textContent = ''; // Clear previous errors
            // Set loading states
            // if (!percentageTextElement.textContent.includes('%')) percentageTextElement.textContent = 'Updating...';
            // if (!peopleCountElement.textContent.includes('people')) peopleCountElement.textContent = 'Updating count...';


            try {
                const response = await fetch(SHEET_URL + '&cachebust=' + new Date().getTime());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const text = await response.text();
                const rows = text.split('\n');

                // --- Extract Percentage ---
                let percentageValue = null;
                if (rows.length > PERCENTAGE_ROW_INDEX) {
                    const cols = rows[PERCENTAGE_ROW_INDEX].split(',');
                    if (cols.length > PERCENTAGE_COL_INDEX) {
                        percentageValue = cols[PERCENTAGE_COL_INDEX].replace(/^"|"$/g, ''); // Clean quotes
                    } else {
                        throw new Error(`Percentage column index ${PERCENTAGE_COL_INDEX} out of bounds.`);
                    }
                } else {
                    throw new Error(`Percentage row index ${PERCENTAGE_ROW_INDEX} out of bounds.`);
                }

                 // --- Extract People Count ---
                let peopleCountValue = null;
                // Ensure the SPECIFIC row for the count exists
                if (rows.length > COUNT_ROW_INDEX) {
                    // *** The Key Fix: Split the CORRECT row string for the count ***
                    const countCols = rows[COUNT_ROW_INDEX].split(',');
                    // Now access the column within that specific row's columns
                    if (countCols.length > COUNT_COL_INDEX) {
                        peopleCountValue = countCols[COUNT_COL_INDEX].replace(/^"|"$/g, '');
                    } else {
                         // Don't throw error here, just log it maybe, or set count to 'N/A'
                         console.warn(`Count column index ${COUNT_COL_INDEX} out of bounds.`);
                         peopleCountValue = 'N/A'; // Indicate count couldn't be found
                    }
                } else {
                    // Don't throw error here, just log it maybe, or set count to 'N/A'
                    console.warn(`Count row index ${COUNT_ROW_INDEX} out of bounds.`);
                    peopleCountValue = 'N/A'; // Indicate count couldn't be found
                }


                // --- Process and Update Percentage ---
                let numericPercentage = NaN;
                if (percentageValue !== null) {
                    numericPercentage = parseFloat(percentageValue.toString().replace('%', ''));
                }
                if (isNaN(numericPercentage)) {
                    console.error(`Invalid percentage data: "${percentageValue}"`); // Log specific error
                    percentageTextElement.textContent = 'Invalid %';
                    progressBarElement.style.width = '0%'; // Reset bar on bad data
                    progressBarElement.setAttribute('aria-valuenow', 0);
                } else {
                     if (Math.abs(numericPercentage) <= 1 && percentageValue.toString().indexOf('%') === -1) {
                         numericPercentage *= 100;
                     }
                     const validPercentage = Math.max(0, Math.min(100, numericPercentage));
                     progressBarElement.style.width = validPercentage + '%';
                     progressBarElement.setAttribute('aria-valuenow', validPercentage.toFixed(1));
                     percentageTextElement.textContent = validPercentage.toFixed(1) + '%';
                     percentageTextElement.classList.remove('loading');
                }

                 // --- Extract People Count ---
                 let amountMembersValue = null;
                // Ensure the SPECIFIC row for the count exists
                if (rows.length > MEM_ROW_INDEX) {
                    // *** The Key Fix: Split the CORRECT row string for the count ***
                    const countCols = rows[MEM_ROW_INDEX].split(',');
                    // Now access the column within that specific row's columns
                    if (countCols.length > MEM_COL_INDEX) {
                        amountMembersValue = countCols[MEM_COL_INDEX].replace(/^"|"$/g, '');
                    } else {
                         // Don't throw error here, just log it maybe, or set count to 'N/A'
                         console.warn(`Count column index ${MEM_COL_INDEX} out of bounds.`);
                         amountMembersValue = 'N/A'; // Indicate count couldn't be found
                    }
                } else {
                    // Don't throw error here, just log it maybe, or set count to 'N/A'
                    console.warn(`Count row index ${MEM_ROW_INDEX} out of bounds.`);
                    amountMembersValue = 'N/A'; // Indicate count couldn't be found
                }

                // --- Extract People Count ---
                let membersNeededValue = null;
                // Ensure the SPECIFIC row for the count exists
                if (rows.length > NEED_ROW_INDEX) {
                    // *** The Key Fix: Split the CORRECT row string for the count ***
                    const countCols = rows[NEED_ROW_INDEX].split(',');
                    // Now access the column within that specific row's columns
                    if (countCols.length > NEED_COL_INDEX) {
                        membersNeededValue = countCols[NEED_COL_INDEX].replace(/^"|"$/g, '');
                    } else {
                         // Don't throw error here, just log it maybe, or set count to 'N/A'
                         console.warn(`Count column index ${NEED_COL_INDEX} out of bounds.`);
                         membersNeededValue = 'N/A'; // Indicate count couldn't be found
                    }
                } else {
                    // Don't throw error here, just log it maybe, or set count to 'N/A'
                    console.warn(`Count row index ${NEED_ROW_INDEX} out of bounds.`);
                    membersNeededValue = 'N/A'; // Indicate count couldn't be found
                }


                // --- Process and Update People Count ---
                 // Basic check if count value looks like a number or is 'N/A'

                 if (amountMembersValue !== null && (amountMembersValue === 'N/A' || !isNaN(parseInt(amountMembersValue)))) {
                     if (amountMembersValue === 'N/A') {
                        amountMembersElement.textContent = 'Count data unavailable.';
                     } else {
                        amountMembersElement.textContent = ` We hebben op dit moment ${amountMembersValue} leden in de vereniging. Er moet tweederde daarvan gerepresenteerd zijn op de ALV. Dat zijn ${membersNeededValue} mensen.  Er zijn op dit moment ${peopleCountValue} mensen gerepresenteerd. Dat is ${numericPercentage}% van het totaal dat we nodig hebben.`;
                     }
                 } else {
                     console.error(`Invalid count data: "${peopleCountValue}"`);
                     amountMembersElement.textContent = 'Invalid count data.';
                 }
                 amountMembersElement.classList.remove('loading'); // Remove loading class if any

                //  if (membersNeededValue !== null && (membersNeededValue === 'N/A' || !isNaN(parseInt(membersNeededValue)))) {
                //      if (membersNeededValue === 'N/A') {
                //          membersNeededElement.textContent = 'Count data unavailable.';
                //      } else {
                //          membersNeededElement.textContent = ` Er moet tweederde daarvan gerepresenteerd zijn op de ALV. Dat zijn ${membersNeededValue} mensen. `;
                //      }
                //  } else {
                //      console.error(`Invalid count data: "${membersNeededValue}"`);
                //      membersNeededElement.textContent = 'Invalid count data.';
                //  }

                //  peopleCountElement.classList.remove('loading'); // Remove loading class if any

                //  if (peopleCountValue !== null && (peopleCountValue === 'N/A' || !isNaN(parseInt(peopleCountValue)))) {
                //      if (peopleCountValue === 'N/A') {
                //          peopleCountElement.textContent = 'Count data unavailable.';
                //      } else {
                //          peopleCountElement.textContent = ` Er zijn op dit moment ${peopleCountValue} mensen gerepresenteerd. Dat is ${numericPercentage}% van het totaal dat we nodig hebben.`;
                //      }
                //  } else {
                //      console.error(`Invalid count data: "${peopleCountValue}"`);
                //      peopleCountElement.textContent = 'Invalid count data.';
                //  }
                //  peopleCountElement.classList.remove('loading'); // Remove loading class if any

            } catch (error) {
                console.error('Failed to fetch or update data:', error);
                // Display general error and reset UI elements
                errorElement.textContent = `Error: ${error.message}`;
                percentageTextElement.textContent = 'Error';
                progressBarElement.style.width = '0%';
                progressBarElement.setAttribute('aria-valuenow', 0);
                peopleCountElement.textContent = 'Count unavailable due to error.'; // Update count display on error
            }
        }

        // Initial fetch
        fetchAndUpdateData();

        // Set up polling
        setInterval(fetchAndUpdateData, POLLING_INTERVAL_MS);

    </script>
</body>
</html>